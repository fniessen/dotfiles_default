#!/usr/bin/env bash

BLU=$(tput bold)$(tput setaf 4)
reset=$(tput sgr0)

if [[ $(stat -c %A ~/.ssh/config) != "-rw-------" ]]; then
    echo "Bad permissions on ~/.ssh/config.  Fixing it..."
    chmod 600 ~/.ssh/config
fi

printf '%s\n\n' "Searching at most 5 levels of directories..."

# Handle directories with spaces in find command.
find . -maxdepth 5 -name ".git" -type d | rev | cut -c 6- | rev | sed "s#^\./##" |
    while IFS=$'\n' read -r repo; do
        printf '%s\n' "Current repository: ${BLU}$repo${reset}"
        git -C "$repo" pull
        git -C "$repo" push --tags      # Push the current branch (not all
                                        # branches! -- see push.default).
        echo
    done
